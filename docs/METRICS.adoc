= Setup Prometheus and Grafana

We will use Prometheus to read metrics information from our Backend app and use Grafana to visualized these data

We will use Operator to setup both Prometheus and Grafana.

== Backend App Metrics data

Our backend apps use microprofiles metrics along with annotation in code to exposes their statistics.  These can be acess via URI /metrics

You can test this with Backend app running on your local machine.

[source,bash]
----
curl http://localhost:8080/metrics
curl http://localhost:8080/metrics/application
# or with header Accept: application/json
curl -H "Accept: application/json" http://localhost:8080/metrics
curl -H "Accept: application/json" http://localhost:8080/metrics/application
----

== Prepare Environment

We will deploy backend application in project demo, Prometheus and Grafana in projct app-monitoring

* Create project and deploy backend application

[source,bash]
----
oc new-project demo --display-name="Demo"
oc new-project app-monitor --display-name="Application Monitor"
oc apply -f metrics/backend-deployment.yml -n demo
oc apply -f metrics/backend-service.yml -n demo
oc expose svc backend -n demo
----

* Install Prometheus Operator and Grafana Operator to project app-monitor

== Setup Prometheus

* Check that Prometheus operator is already installed on project app-monitor

[source,bash]
----
oc get pods -n app-monitor
# Output
NAME                                  READY   STATUS    RESTARTS   AGE
prometheus-operator-56748d4c5-nv8nx   1/1     Running   1          19h
----

* Create Service Account, Service Monitor and Prometheus 

[source,bash]
----
oc apply -f metrics/service_account.yaml -n app-monitor
oc apply -f metrics/service_monitor.yaml -n app-monitor
oc apply -f metrics/prometheus.yaml -n app-monitor
# Check that prometheus is up and running
oc get pods -n app-monitor
NAME                                  READY   STATUS    RESTARTS   AGE
prometheus-operator-56748d4c5-nv8nx   1/1     Running   1          19h
prometheus-prometheus-0               3/3     Running   1          4h33m
prometheus-prometheus-1               3/3     Running   1          4h33m
----

* Take a look at link:../metrics/service_monitor.yaml[service_monitor.yaml]

[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: app-monitor
  labels:
    k8s-app: app-monitor
  # Deploy in namespace app-monitor
  namespace: app-monitor
spec:
  namespaceSelector:
    # Read data from namespace demo
    matchNames:
      - demo
  selector:
    matchLabels:
      # Read data from service with label app eqauls to backend
      app: backend
  endpoints:
    - interval: 30s
      # Read data from URI /metrics
      path: /metrics
      # Port name need to be matched with port in service to be monitored 
      port: http
----
* Need to create service and route??
* Check Service Monitor

image::imagesdir/prometheus-service-discovery.png[]

* Check Target

image::imagesdir/prometheus-target.png[]

* Some load ... and check for Prometheus graph

image::imagesdir/prometheus-request-per-minute.png[]

== Setup Grafana

* Check that Prometheus operator is already installed on project app-monitor

[source,bash]
----
oc get pods -n app-monitor
# Output
NAME                                  READY   STATUS    RESTARTS   AGE
...

grafana-operator-659b968c55-798l5     1/1     Running   0          6h27m

...
----

* Create DataSource, Grafana and Dashboard

[source,bash]
----
oc apply -f metrics/grafana_datasource.yaml -n app-monitor
oc apply -f metrics/grafana.yaml -n app-monitor
oc apply -f metrics/garfana_dashboard.yaml -n app-monitor
# Check for Grafana pod
oc get pods -n app-monitor
NAME                                  READY   STATUS    RESTARTS   AGE
grafana-deployment-64f8b9cdd9-pj5fs   1/1     Running   0          179m
grafana-operator-659b968c55-798l5     1/1     Running   0          6h27m
prometheus-operator-56748d4c5-nv8nx   1/1     Running   1          19h
prometheus-prometheus-0               3/3     Running   1          4h33m
prometheus-prometheus-1               3/3     Running   1          4h33m
----

* Login to Grafana. Check for URL by using following command

[source,bash]
----
oc get route grafana-route -n app-monitor -o jsonpath='{.spec.host}'
# You need to use https://<route URL>
----

* Login to Grafana with default user and password (Check user and password in link:../metrics/grafana.yaml[grafana.yaml]

* Check for Grafana Dashboard

image::imagesdir/grafana-dashboard.png[]

